package snippets

import (
	"errors"
	"fmt"
	"io"
	"strings"

	"k8s.io/gengo/generator"
	"k8s.io/gengo/types"
)

func GenerateSetter(w io.Writer, ctx *generator.Context, root *types.Type, member types.Member, hasParent bool, embedded *types.Type) error {
	if root == nil {
		return errors.New("nil pointer")
	}

	args := generator.Args{
		"type":       root,
		"funcName":   funcName(member),
		"memberName": member.Name,
		"memberType": member.Type,
	}

	if embedded != nil {
		args["embeddedTypeName"] = embedded.Name.Name
	}

	assignment := "o.$.memberName$"
	if hasParent {
		assignment = "o.$.type|raw$.$.memberName$"
	}

	var sb strings.Builder
	sb.WriteString("// $.funcName$ is an autogenerated setter function.\n")

	if member.Type.Kind == types.Map {
		// done
		sb.WriteString("func (o *$.type|raw$) $.funcName$(in $.memberType|raw$) *$.type|raw$ {\n")
		sb.WriteString(fmt.Sprintf("%s = mergeMapStringString(%s, in)\n", assignment, assignment))
	} else if member.Type.Kind == types.Slice {
		args["memberElemType"] = member.Type.Elem
		sb.WriteString("func (o *$.type|raw$) $.funcName$(in ...$.memberElemType|raw$) *$.type|raw$ {\n")
		if embedded != nil {
			// needs translation from struct to pull out the embeddedType
			sb.WriteString("for _, elem := range in {\n")
			sb.WriteString(fmt.Sprintf("%s = append(%s, elem.$.embeddedTypeName$)\n", assignment, assignment))
			sb.WriteString("}\n")
		} else {
			sb.WriteString(fmt.Sprintf("%s = append(%s, in...)\n", assignment, assignment))
		}
	} else if member.Type.Kind == types.Struct {
		sb.WriteString("func (o *$.type|raw$) $.funcName$(in $.memberType|raw$) *$.type|raw$ {\n")
		if embedded != nil {
			// needs translation from struct to pull out the embeddedType
			sb.WriteString(fmt.Sprintf("%s = in.$.embeddedTypeName$\n", assignment))
		} else {
			sb.WriteString(fmt.Sprintf("%s = in\n", assignment))
		}
	} else if member.Type.Kind == types.Pointer && member.Type.Elem.Kind == types.Builtin {
		args["memberElemType"] = member.Type.Elem
		// convert from builtin type to pointer
		sb.WriteString("func (o *$.type|raw$) $.funcName$(in $.memberElemType|raw$) *$.type|raw$ {\n")
		sb.WriteString(fmt.Sprintf("%s = &in\n", assignment))
	} else {
		//done
		sb.WriteString("func (o *$.type|raw$) $.funcName$(in $.memberType|raw$) *$.type|raw$ {\n")
		sb.WriteString(fmt.Sprintf("%s = in\n", assignment))
	}

	sb.WriteString("return o\n")
	sb.WriteString("}\n\n")

	return writeSnippetWithArgs(w, ctx, sb.String(), args)
}

func funcName(m types.Member) string {
	verb := "With"

	if m.Type.Kind == types.Slice {
		verb = "Append"
	}

	return fmt.Sprintf("%s%s", verb, m.Name)
}

func setterPrimitive(root *types.Type, member types.Member) (string, generator.Args) {
	args := generator.Args{
		"type":       root,
		"funcName":   funcName(member),
		"memberName": member.Name,
		"memberType": member.Type,
	}

	raw := `// $.funcName$ is an autogenerated setter function.
func (o *$.type|raw$) $.funcName$(in $.memberType|raw$) *$.type|raw$ {
	o.$.memberName$ = in
	return o
}

`
	return raw, args
}

func setterMap(root *types.Type, member types.Member) (string, generator.Args) {
	args := generator.Args{
		"type":       root,
		"funcName":   funcName(member),
		"memberName": member.Name,
		"memberType": member.Type,
	}

	raw := `// $.funcName$ is an autogenerated setter function.
func (o *$.type|raw$) $.funcName$(in $.memberType|raw$) *$.type|raw$ {
	o.$.memberName$ = mergeMapStringString(o.$.memberName$, in)
	return o
}

`
	return raw, args
}
